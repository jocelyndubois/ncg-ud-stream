<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<link rel="stylesheet" href="css/global.css">
	<link rel="stylesheet" href="css/ud.css">

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"
			integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
	<script type="text/javascript" src="js/replicants.js"></script>
	<script type="text/javascript" src="js/utils.js"></script>
</head>
<body>
<div class="container">
	<form class="row g-3">
		<div class="col-md-6">
			<label for="seasonInput" class="form-label">Season :</label>
			<div class="input-group mb-3">
				<input type="number" class="form-control" id="seasonInput" id="seasonInput">
				<div class="input-group-append">
					<button class="btn btn-outline-primary" id="fetchGamesButton" type="button">Fetch Games</button>
				</div>
			</div>
		</div>
		<div class="col-md-6">
			<label for="gameSelect" class="form-label">Game :</label>
			<select class="form-control form-select form-select-sm" name="gameSelect" id="gameSelect"></select>
		</div>
		<div class="col-6">
			<label for="gameName" class="form-label">Name</label>
			<input disabled type="text" class="form-control" id="gameName">
		</div>
		<div class="col-md-4">
			<label for="gameColor" class="form-label">Color</label>
			<input disabled type="text" class="form-control" id="gameColor">
		</div>
		<div class="col-md-2">
			<span class="glyph" id="game-glyph"></span>
		</div>
		<div class="col-6">
			<label for="lightDarkBox" class="form-label">Light/Dark</label>
			</br>
			<label class="switch">
				<input type="checkbox" id="lightDarkBox" />
				<span id="slider" class="slider round"></span>
			</label>
		</div>
		<div class="col-6">
			<div id="categoryDivLight" class="categoryDiv">
				<label for="gameCategoryLight" class="form-label">Category</label>
				<input disabled type="text" class="form-control" id="gameCategoryLight">
			</div>
			<div id="categoryDivDark" class="categoryDiv hidden">
				<label for="gameCategoryDark" class="form-label">Category</label>
				<input disabled type="text" class="form-control" id="gameCategoryDark">
			</div>
		</div>
		<div class="col-md-12 hidden">
			<table class="table">
				<tbody>
				<tr>
					<th>&nbsp;</th>
					<th>200 pts</th>
					<th>100 pts</th>
					<th>0 pts</th>
					<th>min</th>
					<th>max</th>
				</tr>
				</tbody>
				<tbody>
				<tr>
					<td>LIGHT</td>
					<td><input disabled type="text" class="form-control" id="gameMaxTimeLight"></td>
					<td><input disabled type="text" class="form-control" id="gameMidTimeLight"></td>
					<td><input disabled type="text" class="form-control" id="gameFewTimeLight"></td>
					<td><input disabled type="text" class="form-control" id="gameMinScoreLight"></td>
					<td><input disabled type="text" class="form-control" id="gameMaxScoreLight"></td>
				</tr>
				<tr>
					<td>DARK</td>
					<td><input disabled type="text" class="form-control" id="gameMaxTimeDark"></td>
					<td><input disabled type="text" class="form-control" id="gameMidTimeDark"></td>
					<td><input disabled type="text" class="form-control" id="gameFewTimeDark"></td>
					<td><input disabled type="text" class="form-control" id="gameMinScoreDark"></td>
					<td><input disabled type="text" class="form-control" id="gameMaxScoreDark"></td>
				</tr>
				</tbody>
			</table>
		</div>
		<div class="col-md-12">
			<table class="table">
				<tbody>
				<tr>
					<th><b>PB</b></th>
					<th>SCORE</th>
					<th>TIME</th>
				</tr>
				</tbody>
				<tbody>
				<tr id="PBDivLight">
					<td>LIGHT</td>
					<td><input disabled type="text" class="form-control" id="PbLightScore"></td>
					<td><input disabled type="text" class="form-control" id="PbLightTime"></td>
				</tr>
				<tr id="PBDivDark" class="hidden">
					<td>DARK</td>
					<td><input disabled type="text" class="form-control" id="PbDarkScore"></td>
					<td><input disabled type="text" class="form-control" id="PbDarkTime"></td>
				</tr>
				</tbody>
			</table>
		</div>
	</form>

	<div class="row">
		<div class="col-7">
			<h4>Display PB and category:</h4>
			<a class="btn btn-primary" id="sendPB">SEND</a>
			<a class="btn btn-danger" id="hidePB">HIDE</a>
			<h4>Card:</h4>
			<a class="btn btn-primary" id="showCard">SHOW</a>
			<a class="btn btn-danger" id="hideCard">HIDE</a>
		</div>
		<div class="col-4">
			<h4>Chrono</h4>
			<label for="callLivesplit">Use Livesplit ?</label>
			<input id="callLivesplit" type="checkbox" checked />
			</br>
			<label for="syncLivesplit">[EXPERIMENTAL] Sync ?</label>
			<input id="syncLivesplit" type="checkbox" />
			</br>
			<label for="enableSound">Coundown sound ?</label>
			<input id="enableSound" type="checkbox" />
			</br>
			<input type="number" class="form-control" id="delay" placeholder="delay"/>
			</br>
			<a class="btn btn-primary" data-todo="start" id="startPause">
				<svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 36 36">
					<path id="ytp-12" d="M11,10 L18,13.74 18,22.28 11,26 M18,13.74 L26,18 26,18 18,22.28">
						<animate id="animation" begin="indefinite" attributeType="XML" attributeName="d" fill="freeze"
								 from="M11,10 L18,13.74 18,22.28 11,26 M18,13.74 L26,18 26,18 18,22.28"
								 to="M11,10 L17,10 17,26 11,26 M20,10 L26,10 26,26 20,26" dur="0.1s"
								 keySplines=".4 0 1 1" repeatCount="1"></animate>
					</path>
				</svg>
			</a>

			<a class="btn btn-danger" id="stop">
				<svg xmlns="http://www.w3.org/2000/svg" width="13px" height="13px" viewBox="0 0 100 100">
					<path d="M 10 10 H 90 V 90 H 10 L 10 10"/>
				</svg>
			</a>
		</div>
	</div>


</div>
</body>

<script>
	const gameSelect = document.querySelector('#gameSelect');
	const seasonInput = document.querySelector('#seasonInput');
	const fetchGamesButton = document.querySelector('#fetchGamesButton');

	const callLivesplit = document.querySelector('#callLivesplit');

	const sendPB = document.querySelector('#sendPB');
	const hidePB = document.querySelector('#hidePB');

	const showCard = document.querySelector('#showCard');
	const hideCard = document.querySelector('#hideCard');

	const startPause = document.querySelector('#startPause');
	const stop = document.querySelector('#stop');

	const gameName = document.querySelector('#gameName');
	const gameColor = document.querySelector('#gameColor');
	const glyph = document.querySelector('#game-glyph');
	const gameCategoryLight = document.querySelector('#gameCategoryLight');
	const gameCategoryDark = document.querySelector('#gameCategoryDark');
	const gameMaxTimeLight = document.querySelector('#gameMaxTimeLight');
	const gameMidTimeLight = document.querySelector('#gameMidTimeLight');
	const gameFewTimeLight = document.querySelector('#gameFewTimeLight');
	const gameMaxTimeDark = document.querySelector('#gameMaxTimeDark');
	const gameMidTimeDark = document.querySelector('#gameMidTimeDark');
	const gameFewTimeDark = document.querySelector('#gameFewTimeDark');
	const gameMinScoreLight = document.querySelector('#gameMinScoreLight');
	const gameMaxScoreLight = document.querySelector('#gameMaxScoreLight');
	const gameMinScoreDark = document.querySelector('#gameMinScoreDark');
	const gameMaxScoreDark = document.querySelector('#gameMaxScoreDark');

	const categoryDivLight = document.querySelector('#categoryDivLight');
	const categoryDivDark = document.querySelector('#categoryDivDark');

	const PBDivLight = document.querySelector('#PBDivLight');
	const PBDivDark = document.querySelector('#PBDivDark');

	const PbLightScore = document.querySelector('#PbLightScore');
	const PbLightTime = document.querySelector('#PbLightTime');
	const PbDarkScore = document.querySelector('#PbDarkScore');
	const PbDarkTime = document.querySelector('#PbDarkTime');

	const lightDarkBox = document.querySelector('#lightDarkBox');

	const delay = document.querySelector('#delay');
	const delaySound = document.querySelector('#enableSound');

	const syncLivesplit = document.querySelector('#syncLivesplit');

	let categoryChoice;
	let livesplitStatus = false;

	livesplitConnection.on('change', (connectionStatus) => {
		if (connectionStatus) {
			if (syncReplicant.value) {
				syncLivesplit.checked = true;
			}
			syncLivesplit.disabled = false;

			callLivesplit.checked = true;
			callLivesplit.disabled = false;
		} else {
			syncLivesplit.checked = false;
			syncLivesplit.disabled = true;

			callLivesplit.checked = false;
			callLivesplit.disabled = true;
		}

		livesplitStatus = connectionStatus;
	});

	let flip = true,
		pauseSvg = "M11,10 L18,13.74 18,22.28 11,26 M18,13.74 L26,18 26,18 18,22.28",
		playSvg = "M11,10 L17,10 17,26 11,26 M20,10 L26,10 26,26 20,26",
		$animation = $('#animation');

	$(document).ready(function () {
		getCategoryStatus();

		//[DELAY STORAGE]
		delayReplicant.on('change', () => {
			delay.value = delayReplicant.value;
		});

		delay.onchange = () => {
			delayReplicant.value = delay.value;
		};

		//[SOUND STORAGE]
		soundReplicant.on('change', () => {
			if (soundReplicant.value) {
				delaySound.checked = true;
			} else {
				delaySound.checked = false;
			}
		});
		delaySound.onchange = () => {
			soundReplicant.value = delaySound.checked;
		};

		//[SYNC LIVESPLIT]
		syncReplicant.on('change', () => {
			if (syncReplicant.value && livesplitStatus) {
				syncLivesplit.checked = true;
			} else {
				syncLivesplit.checked = false;
			}
		});
		syncLivesplit.onchange = () => {
			syncReplicant.value = syncLivesplit.checked;
		};

		//[LIGHT/DARK STORAGE]
		lightDarkReplicant.on('change', () => {
			if (lightDarkReplicant.value && !lightDarkBox.checked) {
				lightDarkBox.click();
			}
		});
		lightDarkBox.onchange = () => {
			getCategoryStatus();

			if ('light' === categoryChoice) {
				categoryDivLight.classList.remove('hidden');
				PBDivLight.classList.remove('hidden');

				categoryDivDark.classList.add('hidden');
				PBDivDark.classList.add('hidden');
			} else {
				categoryDivLight.classList.add('hidden');
				PBDivLight.classList.add('hidden');

				categoryDivDark.classList.remove('hidden');
				PBDivDark.classList.remove('hidden');
			}

			sendPb();

			lightDarkReplicant.value = lightDarkBox.checked;
		}

		fetchGamesButton.onclick = () => {
			nodecg.sendMessage(
				'fetchGamesList',
				seasonInput.value
			);
		};

		//[CHRONO]
		stop.onclick = () => {
			nodecg.sendMessage('stopTimer');

			if ('start' !== startPause.dataset.todo) {
				startPause.dataset.todo = 'start';

				$animation.attr({
					"from": playSvg,
					"to": pauseSvg
				}).get(0).beginElement();
			}

			if (callLivesplit.checked) {
				nodecg.sendMessageToBundle('livesplit:sendAction', 'ncg-ud-stream', 'reset');
			}
		};
		startPause.onclick = () => {
			if ('pause' === startPause.dataset.todo) {
				nodecg.sendMessage('pauseTimer');

				if (callLivesplit.checked) {
					nodecg.sendMessageToBundle('livesplit:sendAction', 'ncg-ud-stream', 'pause');
				}

				startPause.dataset.todo = 'resume';

				$animation.attr({
					"from": playSvg,
					"to": pauseSvg
				}).get(0).beginElement();
			} else if ('start' === startPause.dataset.todo) {
				if (delay.value && parseInt(delay.value) > 0) {
					nodecg.sendMessage(
						'preTimer',
						{
							delay: delay.value,
							delaySound: delaySound.checked,
							color: gameColor.value,
						}
					);
				}

				nodecg.sendMessage(
					'startTimer',
					{
						category: categoryChoice,
						delay: delay.value,
						livesplit: callLivesplit.checked,
						light: {
							bestTime: gameMaxTimeLight.dataset.seconds,
							middleTime: gameMidTimeLight.dataset.seconds,
							minScore: gameMinScoreLight.value,
							maxScore: gameMaxScoreLight.value,
						},
						dark: {
							bestTime: gameMaxTimeDark.dataset.seconds,
							middleTime: gameMidTimeDark.dataset.seconds,
							minScore: gameMinScoreDark.value,
							maxScore: gameMaxScoreDark.value,
						}
					}
				);

				startPause.dataset.todo = 'pause';

				$animation.attr({
					"from": pauseSvg,
					"to": playSvg
				}).get(0).beginElement();
			} else {
				nodecg.sendMessage('resumeTimer');

				if (callLivesplit.checked) {
					nodecg.sendMessageToBundle('livesplit:sendAction', 'ncg-ud-stream', 'resume');
				}

				startPause.dataset.todo = 'pause';

				$animation.attr({
					"from": pauseSvg,
					"to": playSvg
				}).get(0).beginElement();
			}
		};

		//[PB]
		sendPB.onclick = () => {
			let category = '';
			let score = 0;
			let time = '';
			if ('light' === categoryChoice) {
				category = gameCategoryLight.value;
				score = parseInt(PbLightScore.value);
				time = PbLightTime.value;
			} else {
				category = gameCategoryDark.value;
				score = parseInt(PbDarkScore.value);
				time = PbDarkTime.value;
			}

			nodecg.sendMessage(
				'showPB',
				{
					color: gameColor.value,
					game: gameSelect.value,
					category: category,
					score: score,
					time: time
				}
			);

			sendGameGlyph(gameSelect.value, seasonInput.value);
		};
		hidePB.onclick = () => {
			nodecg.sendMessage(
				'hidePB'
			);
		};

		//[CARD]
		showCard.onclick = () => {
			nodecg.sendMessage(
				'showCard',
				{
					runner: runnerName.value,
					season: seasonInput.value,
				}
			);
		};
		hideCard.onclick = () => {
			nodecg.sendMessage(
				'hideCard'
			);
		};

		//[TRIGGERS Seasons/Game]
		seasonInput.onchange = () => {
			season.value = seasonInput.value;
		}
		season.on('change', () => {
			seasonInput.value = season.value;
		});
		gameSelect.onchange = () => {
			game.value = gameSelect.value;

			nodecg.sendMessage(
				'getGameInfos',
				{
					season: seasonInput.value,
					game: gameSelect.value
				},
			);

			nodecg.sendMessage(
				'fetchPbs',
				{
					season: seasonInput.value,
					game: gameSelect.value
				},
			);
		}
		fetchGamesListReplicant.on('change', (newValue) => {
			if (!newValue) {
				return;
			}

			if (gameSelect.options) {
				//First, we clear the old games list.
				var length = gameSelect.options.length;
				for (let i = length - 1; i >= 0; i--) {
					gameSelect.options[i].remove();
				}
			}

			//Then we add the new one.
			for (let i = 0; i < newValue.length; i++) {
				let game = document.createElement("option");
				game.value = newValue[i];
				game.text = newValue[i];

				gameSelect.add(game);
			}

			season.value = seasonInput.value;
			gameSelect.onchange();
		});
		gameInfos.on('change', (infos) => {
			if (!infos) {
				return;
			}

			gameName.value = infos.name;
			gameColor.value = infos.hexColor;
			gameColor.style.backgroundColor = '#' + infos.hexColor;
			gameColor.style.color = 'white';
			glyph.setAttribute('class', '');
			glyph.classList.add('glyph-game-' + string_to_slug(infos.name));

			gameCategoryLight.value = infos.light.category;
			gameCategoryDark.value = infos.dark.category;


			gameMinScoreLight.value = infos.light.minScore ? infos.light.minScore : '';
			gameMaxScoreLight.value = infos.light.maxScore ? infos.light.maxScore : '';
			gameMinScoreDark.value = infos.dark.minScore ? infos.dark.minScore : '';
			gameMaxScoreDark.value = infos.dark.maxScore ? infos.dark.maxScore : '';

			gameMaxTimeLight.value = new Date(infos.light.bestTime * 1000).toISOString().substr(11, 8);
			gameMaxTimeLight.dataset.seconds = infos.light.bestTime;
			gameMidTimeLight.value = new Date(infos.light.middleTime * 1000).toISOString().substr(11, 8);
			gameMidTimeLight.dataset.seconds = infos.light.middleTime;
			gameFewTimeLight.value = new Date(infos.light.fewestTime * 1000).toISOString().substr(11, 8);
			gameFewTimeLight.dataset.seconds = infos.light.fewestTime;

			gameMaxTimeDark.value = new Date(infos.dark.bestTime * 1000).toISOString().substr(11, 8);
			gameMaxTimeDark.dataset.seconds = infos.dark.bestTime;
			gameMidTimeDark.value = new Date(infos.dark.middleTime * 1000).toISOString().substr(11, 8);
			gameMidTimeDark.dataset.seconds = infos.dark.middleTime;
			gameFewTimeDark.value = new Date(infos.dark.fewestTime * 1000).toISOString().substr(11, 8);
			gameFewTimeDark.dataset.seconds = infos.dark.fewestTime;

			sendPb();
		});

		fetchPbsReplicant.on('change', (PB) => {
			if (!PB) {
				return;
			}

			let lightScore = 0;
			let lightTime = "";
			if (PB.light && PB.light.score) {
				lightScore = PB.light.score;
				lightTime = new Date(PB.light.time * 1000).toISOString().substr(11, 8);
			}
			PbLightScore.value = lightScore;
			PbLightTime.value = lightTime;

			let darkScore = 0;
			let darkTime = "";
			if (PB.dark && PB.dark.score) {
				darkScore = PB.dark.score;
				darkTime = new Date(PB.dark.time * 1000).toISOString().substr(11, 8);
			}
			PbDarkScore.value = darkScore;
			PbDarkTime.value = darkTime;

			sendPb();
		});
	});

	function sendPb(forced = false)
	{
		if (forced || autoSendReplicant.value) {
			sendPB.onclick();
		}
	}

	function getCategoryStatus()
	{
		categoryChoice = lightDarkBox.checked ? 'dark' : 'light';
	}
</script>
</html>
